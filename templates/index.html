<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z√© do Financeiro - Seu Guia de Bolso!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilo.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <img src="{{ url_for('static', filename='img/logo_ze_financeiro.png') }}" alt="Logo Z√© do Financeiro" id="chatLogo"> 
            <h2>Z√© do Financeiro</h2>
            <p>Seu guia de bolso para o microempreendedor digitalizado!</p>
        </div>
        <div class="chat-messages" id="chatMessages">
            </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="Digite sua mensagem aqui...">
            <button id="sendButton">Enviar</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        let loadingMessageDiv = null;
        let userName = localStorage.getItem('userName');
        let esperandoNome = false; 

        const NOME_CHATBOT_FRONTEND = "Z√© do Financeiro"; 

        // Fun√ß√£o para adicionar mensagem ao chat
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            // Usa o nome do usu√°rio se existir, sen√£o usa "Voc√™"
            const displayName = sender === 'user' ? (userName || 'Voc√™') : NOME_CHATBOT_FRONTEND;

            if (sender === 'user') {
                messageDiv.classList.add('user-message');
                messageDiv.innerHTML = `<strong>${displayName}:</strong> `;
                // Adiciona o texto do usu√°rio como n√≥ de texto para evitar renderiza√ß√£o de HTML acidental
                messageDiv.appendChild(document.createTextNode(text));
            } else { // sender === 'bot' ou 'system' (para mensagens do pr√≥prio frontend)
                messageDiv.classList.add('bot-message');
                messageDiv.innerHTML = `<strong>${displayName}:</strong> `;
                const contentDiv = document.createElement('div');
                contentDiv.style.display = 'inline'; // Para conte√∫do ficar ao lado do nome
                // Converte o texto do bot de Markdown para HTML se for uma resposta do bot
                // Para mensagens do sistema (frontend), n√£o precisa de parse Markdown
                contentDiv.innerHTML = (sender === 'bot' && typeof marked !== 'undefined') ? marked.parse(text || "") : (text || "");
                messageDiv.appendChild(contentDiv);
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; 
        }

        function showLoadingIndicator() {
            if (loadingMessageDiv) { 
                loadingMessageDiv.remove();
            }
            loadingMessageDiv = document.createElement('div');
            loadingMessageDiv.classList.add('message', 'bot-message', 'loading-indicator'); 
            
            const strong = document.createElement('strong');
            strong.textContent = `${NOME_CHATBOT_FRONTEND}:`;
            loadingMessageDiv.appendChild(strong);

            const content = document.createElement('div');
            content.style.display = 'inline';
            content.innerHTML = ' Estou pensando um cadinho, ' + (userName || 'meu patr√£o/minha patroa') + '... üß†'; 
            loadingMessageDiv.appendChild(content);
            
            chatMessages.appendChild(loadingMessageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideLoadingIndicator() {
            if (loadingMessageDiv) {
                loadingMessageDiv.remove();
                loadingMessageDiv = null; 
            }
        }

        async function sendMessageToBot(messageText) {
            // Se estiver esperando o nome do usu√°rio
            if (esperandoNome) {
                const nomeDigitado = messageText.trim();
                if (nomeDigitado) {
                    userName = nomeDigitado; // Atualiza a vari√°vel global userName
                    localStorage.setItem('userName', userName); 
                    addMessage(userName, 'user'); // Mostra o nome que o usu√°rio digitou
                    
                    esperandoNome = false;
                    userInput.placeholder = "Digite sua mensagem aqui...";
                    userInput.value = ''; // Limpa o input ap√≥s pegar o nome
                    
                    // Mensagem de boas-vindas do frontend ap√≥s pegar o nome
                    addMessage(`Prazer em te conhecer, ${userName}! Em que posso te ajudar agora?`, 'bot'); 
                    
                    // Envia o nome para o backend para registrar na sess√£o Flask
                    try {
                        console.log(`[FRONTEND] Enviando nome '${userName}' para o backend...`);
                        const responseNome = await fetch('/webhook', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nome_usuario: userName, mensagem: "REGISTRO_DE_NOME_USUARIO" }),
                        });
                        if (!responseNome.ok) {
                            console.error("[FRONTEND] Erro ao registrar nome no backend:", responseNome.statusText);
                        } else {
                            const dataNome = await responseNome.json();
                            console.log("[FRONTEND] Resposta do backend ao registrar nome:", dataNome);
                            // Se o backend confirmar com uma mensagem, poderia ser adicionada aqui.
                            // Ex: if (dataNome.resposta_bot) { addMessage(dataNome.resposta_bot, 'bot'); }
                        }
                    } catch (error) {
                        console.error('[FRONTEND] Erro ao enviar nome para o backend:', error);
                    }
                    userInput.focus();
                    return; // Sai da fun√ß√£o ap√≥s tratar o nome
                } else {
                    addMessage("Oxe, parece que voc√™ n√£o digitou um nome. Pode tentar de novo?", 'bot'); // Mensagem do bot/sistema
                    userInput.focus();
                    return; // Sai para o usu√°rio tentar de novo
                }
            }

            // Fluxo normal de envio de mensagem
            addMessage(messageText, 'user');
            userInput.value = ''; 
            userInput.disabled = true;
            sendButton.disabled = true;
            showLoadingIndicator();

            try {
                let url = `/webhook`; // Vamos usar POST
                let fetchOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mensagem: messageText, nome_usuario: userName }) // Envia nome_usuario sempre
                };
                
                // Se fosse GET (como antes, mas agora estamos mudando para POST):
                // let url = `/webhook?mensagem=${encodeURIComponent(messageText)}`;
                // if (userName) { // Envia o nome se j√° o tivermos
                //    url += `&nome_usuario=${encodeURIComponent(userName)}`;
                // }

                const response = await fetch(url, fetchOptions);
                
                hideLoadingIndicator(); 

                if (!response.ok) {
                    throw new Error(`Erro na requisi√ß√£o: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data && data.resposta_bot) {
                    addMessage(data.resposta_bot, 'bot');
                } else {
                    addMessage("O Z√© n√£o conseguiu processar essa, tente de novo ou de outra forma.", 'bot');
                }

            } catch (error) {
                hideLoadingIndicator(); 
                console.error('[FRONTEND] Erro ao enviar mensagem:', error);
                addMessage(`Oxe, deu um piripaque na minha conex√£o com o Z√©! Tenta de novo daqui a pouquinho. (Erro: ${error.message})`, 'bot');
            } finally {
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            }
        }

        // L√≥gica de inicializa√ß√£o do chat
        function iniciarChat() {
            if (userName) {
                addMessage(`De volta, ${userName}! Sou o ${NOME_CHATBOT_FRONTEND}. Em que posso te ajudar hoje?`, 'bot');
                userInput.placeholder = "Digite sua mensagem aqui...";
                // Opcional: Informar ao backend que o usu√°rio retornou, para carregar o nome na sess√£o Flask
                // se a sess√£o tiver expirado mas o localStorage ainda tiver o nome.
                 fetch('/webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome_usuario: userName, mensagem: "REINICIO_SESSAO_COM_NOME" })
                 });
            } else {
                addMessage(`Ol√°! Sou o ${NOME_CHATBOT_FRONTEND}. Para nosso papo ficar mais arretado, como posso te chamar?`, 'bot');
                userInput.placeholder = "Digite seu nome aqui...";
                esperandoNome = true;
            }
            userInput.focus();
        }

        sendButton.addEventListener('click', () => {
            const messageText = userInput.value.trim();
            if (messageText) {
                sendMessageToBot(messageText);
            }
        });

        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                const messageText = userInput.value.trim();
                if (messageText) {
                    sendMessageToBot(messageText);
                }
            }
        });

        // Inicia o chat quando a p√°gina carrega
        iniciarChat();
    </script>
</body>
</html>